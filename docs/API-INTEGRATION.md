# API 集成说明文档

## 概述

本文档说明了CUZCUZAI系统与真实API接口的集成实现，包括多种登录方式（邮箱密码、手机密码、手机验证码）、注册、短信/邮箱验证码、请求头配置和数据处理。

## 🔑 登录接口集成

### 密码登录接口
- **接口地址**: `/pod/tenant/api/v1/tenants/login`
- **请求方法**: POST
- **Content-Type**: application/json

#### 请求参数
```json
{
  "email": "用户邮箱地址",    // 邮箱登录时使用
  "phone": "用户手机号",    // 手机号登录时使用
  "password": "用户密码"
}
```

#### 必需请求头
```http
X-Auth-Platform-Type: web
X-Client-Type: cuzcuz-ai-web
```

### 验证码登录接口
- **接口地址**: `/pod/tenant/api/v1/tenants/login-by-sms`
- **请求方法**: POST
- **Content-Type**: application/json

#### 请求参数
```json
{
  "phone": "用户手机号",
  "smsCode": "短信验证码"
}
```

#### 必需请求头
```http
X-Auth-Platform-Type: web
X-Client-Type: cuzcuz-ai-web
```

### 响应数据结构
```json
{
  "accessToken": "访问令牌",
  "avatar": "用户头像URL",
  "email": "用户邮箱",
  "expiresIn": "令牌过期时间",
  "galleryStorageSize": 10,
  "lastLoginTime": "上次登录时间",
  "loginTime": "本次登录时间",
  "nickname": "用户昵称",
  "permissions": [],
  "phone": "手机号",
  "refreshToken": "刷新令牌",
  "role": "用户角色",
  "tenantCode": "租户代码",
  "tenantId": "租户ID",
  "tenantName": "租户名称",
  "tokenType": "Bearer",
  "userId": "用户ID",
  "username": "用户名"
}
```

## 📝 注册接口集成

### 接口信息
- **接口地址**: `/pod/tenant/api/v1/tenants/register`
- **请求方法**: POST
- **Content-Type**: application/json

### 请求参数
```json
{
  "email": "用户邮箱地址",        // 邮箱注册时使用
  "phone": "手机号码",          // 手机号注册时使用
  "password": "用户密码",
  "emailCode": "邮箱验证码",    // 邮箱注册时使用
  "smsCode": "短信验证码",      // 手机号注册时使用
  "nickname": "用户昵称（可选）"
}
```

### 必需请求头
```http
X-Auth-Platform-Type: web
X-Client-Type: cuzcuz-ai-web
```

### 响应数据结构
与登录接口相同，注册成功后直接返回用户信息和令牌。

## 📱 短信验证码接口

### 接口信息
- **接口地址**: `/pod/tenant/api/v1/sms/send-code`
- **请求方法**: POST
- **Content-Type**: application/json

### 请求参数
```json
{
  "phone": "手机号码",
  "type": "register | login | reset" // 验证码类型：register（注册）、login（登录）、reset（重置密码）
}
```

### 必需请求头
```http
X-Auth-Platform-Type: web
X-Client-Type: cuzcuz-ai-web
```

## 📧 邮箱验证码接口

### 接口信息
- **接口地址**: `/pod/tenant/api/v1/email/send-code`
- **请求方法**: POST
- **Content-Type**: application/json

### 请求参数
```json
{
  "email": "邮箱地址",
  "type": "register | login | reset" // 验证码类型：register（注册）、login（登录）、reset（重置密码）
}
```

### 必需请求头
```http
X-Auth-Platform-Type: web
X-Client-Type: cuzcuz-ai-web
```

**注意**: 邮箱验证码接口目前仅用于注册功能，登录暂不支持邮箱验证码。

## 🛠 技术实现

### 1. API客户端配置 (`apis/index.ts`)
- 自动添加认证请求头
- 统一错误处理
- 请求/响应拦截器

### 2. 认证模块 (`apis/auth/index.ts`)
- 密码登录接口实现 (`login`)
- 验证码登录接口实现 (`loginBySms`)
- 注册接口实现
- 短信验证码接口实现
- 邮箱验证码接口实现
- 令牌管理
- 用户信息存储
- 认证状态管理

### 3. 请求头自动注入
系统会自动为所有API请求添加以下请求头（登录后）：
```http
X-Tenant-Id: 租户ID
X-Auth-User-Id: 用户ID
X-Auth-Platform-Type: web
X-Client-Type: cuzcuz-ai-web
Authorization: Bearer [accessToken]
```

## 📱 登录注册页面功能

### 主要功能
1. **多种登录方式**: 
   - 邮箱 + 密码登录
   - 手机号 + 密码登录
   - 手机号 + 验证码登录（忘记密码时的备选方案）
2. **多种注册方式**:
   - 邮箱 + 密码 + 邮箱验证码注册
   - 手机号 + 密码 + 短信验证码注册
3. **智能方式选择**: 一键切换不同的认证方式
4. **验证码系统**: 支持短信和邮箱验证码
5. **记住密码**: 支持记住密码功能（仅密码登录时）
6. **完善验证**: 全面的前端表单验证
7. **友好体验**: 清晰的错误提示和状态反馈

### 用户体验特性
- **忘记密码友好**: 手机号用户可选择验证码登录
- **防频繁发送**: 验证码发送60秒冷却时间
- **智能记忆**: 记住用户偏好的登录方式
- **实时验证**: 表单输入实时验证反馈
- **协议确认**: 注册时必须同意用户协议

### 数据存储
登录/注册成功后，系统会在localStorage中存储：
- `auth_token`: 访问令牌
- `refresh_token`: 刷新令牌
- `user_id`: 用户ID
- `tenant_id`: 租户ID
- `tenant_code`: 租户代码
- `user_info`: 完整用户信息
- `isLoggedIn`: 登录状态标识
- `savedAuthMethod`: 记住的认证方式（email/phone）

## 🔧 测试功能

### API测试页面 (`/test-api`)
提供了专门的测试页面，用于：
- 测试邮箱密码登录
- 测试手机号密码登录
- 测试手机号验证码登录
- 测试邮箱注册（需邮箱验证码）
- 测试手机号注册（需短信验证码）
- 测试发送短信验证码（注册/登录）
- 测试发送邮箱验证码（注册）
- 查看API响应
- 检查认证状态
- 清除认证信息

## 📋 使用说明

### 开发者使用
1. 确保API服务正常运行
2. 使用真实的用户账号进行各种登录方式测试
3. 使用真实的手机号和邮箱进行注册测试
4. 通过 `/test-api` 页面验证所有接口功能

### 用户使用

#### 邮箱密码登录流程
1. 选择"📧 邮箱登录"
2. 输入邮箱地址和密码
3. 可选择记住密码
4. 点击"登录"

#### 手机号密码登录流程
1. 选择"📱 手机登录"
2. 选择"🔑 密码登录"
3. 输入手机号码和密码
4. 可选择记住密码
5. 点击"登录"

#### 手机号验证码登录流程（忘记密码时）
1. 选择"📱 手机登录"
2. 选择"📱 验证码登录"
3. 输入手机号码
4. 点击"获取验证码"接收短信
5. 输入6位验证码
6. 点击"登录"

#### 邮箱注册流程
1. 点击"没有账户？立即注册"
2. 选择"📧 邮箱注册"
3. 输入邮箱地址和密码
4. 点击"获取验证码"接收邮件
5. 输入6位验证码
6. 勾选同意用户协议
7. 点击"创建账户"

#### 手机号注册流程
1. 点击"没有账户？立即注册"
2. 选择"📱 手机注册"
3. 输入手机号码和密码
4. 点击"获取验证码"接收短信
5. 输入6位验证码
6. 勾选同意用户协议
7. 点击"创建账户"

## 🚨 注意事项

1. **接口路径**: 登录、验证码登录、注册、短信、邮箱接口不包含 `/cuzcuz-ai` 前缀
2. **请求头**: 所有登录后的请求都会自动添加认证请求头
3. **表单验证**: 系统包含完善的前端验证，包括邮箱格式、手机号格式、密码长度等
4. **验证码限制**: 验证码发送有60秒冷却时间，防止频繁发送
5. **记住密码**: 仅在密码登录时支持记住密码功能
6. **邮箱验证码**: 目前仅支持注册，登录暂不支持邮箱验证码
7. **错误处理**: 系统已实现完善的错误处理机制
8. **安全性**: 敏感信息存储在localStorage中，请注意安全性

## 🔄 状态管理

系统维护以下认证状态：
- 登录状态检查（密码/验证码）
- 注册状态管理
- 验证码发送状态（短信/邮箱/登录）
- 登录方式记忆
- 令牌自动续期（如需要）
- 用户信息同步
- 权限验证

## 📞 故障排除

### 常见问题
1. **401错误**: 检查用户凭证是否正确
2. **403错误**: 检查用户权限
3. **409错误**: 邮箱或手机号已被注册
4. **422错误**: 验证码错误或已过期
5. **429错误**: 请求过于频繁，需要等待
6. **网络错误**: 检查API服务状态
7. **CORS错误**: 检查跨域配置

### 调试工具
- 使用 `/test-api` 页面进行接口测试
- 查看浏览器开发者工具的Network面板
- 检查Console输出的错误信息
- 验证表单输入格式是否正确

### 验证码相关问题
- 确保手机号格式正确（11位数字，以1开头）
- 确保邮箱格式正确
- 检查验证码是否在有效期内
- 注意验证码发送频率限制
- 确认手机能正常接收短信
- 确认邮箱能正常接收邮件

### 登录方式选择问题
- 忘记密码时可尝试验证码登录（仅手机号）
- 邮箱登录目前仅支持密码方式
- 手机号登录支持密码和验证码两种方式
- 记住密码功能仅在密码登录时有效

---

最后更新时间: 2025-01-31
版本: 3.0.0 